# 賃貸初期費用診断システム - プロジェクト概要

## 📋 プロジェクトの目的

賃貸物件の初期費用見積書と募集図面をAIで分析し、不当な費用を洗い出して削減可能額を提示するWebアプリケーション。ユーザーがスマートフォンで見積書と図面を撮影するだけで、AIが自動的に診断を行い、交渉可能な項目を特定します。

## 🎯 やりたいこと・目指していること

1. **ユーザー体験の向上**
   - スマートフォンから簡単に診断できる
   - カメラで直接撮影できる機能
   - 直感的で分かりやすいUI

2. **診断精度の向上**
   - 図面と見積書を照合して矛盾を検出
   - 各項目に根拠（evidence）を付与
   - 不確実な項目は「要確認」として明示

3. **エンタメ要素の追加**
   - 裏コマンド機能：見積書以外の画像（顔写真、動物、食べ物など）をアップロードすると、占い風の特別診断を表示
   - ユーザーの興味を引く仕掛け

4. **拡散機能**
   - 診断結果をSNS（X、LINE）でシェアできる
   - 共有リンク機能で結果を保存・共有

5. **ビジネス導線**
   - 診断結果から不動産コンサルタントへの相談へ誘導
   - LINEでの無料相談への導線

## 🛠️ 技術スタック

- **フロントエンド**: Next.js 16.1.1, React 19.2.3, TypeScript
- **スタイリング**: Tailwind CSS
- **AI**: Google Gemini API (gemini-2.5-pro / gemini-2.5-flash)
- **画像処理**: html2canvas (結果の画像保存用)
- **デプロイ**: Vercel

## 🏗️ アーキテクチャ

### 全体構成

```
┌─────────────────┐
│  フロントエンド  │
│  (Next.js App)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   API Routes    │
│  /api/analyze   │ ← メイン診断API
│  /api/classify  │ ← 画像分類API
│  /api/share     │ ← 共有機能API
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Gemini API     │
│  (画像解析)     │
└─────────────────┘
```

### データフロー

1. **画像アップロード**
   - 見積書（必須）
   - 募集図面（推奨）
   - 条件欄の拡大画像（任意）

2. **画像分類**
   - 見積書/図面 → 通常診断モード
   - その他（顔、動物、食べ物など） → 裏コマンドモード

3. **診断処理**
   - 画像から情報を抽出
   - 図面と見積書を照合
   - 不当な費用を特定
   - 削減可能額を計算

4. **結果表示**
   - 通常モード：診断結果UI
   - 裏コマンドモード：占い風UI

## 📁 ファイル構成

```
chintai-final/
├── app/
│   ├── api/
│   │   ├── analyze/
│   │   │   └── route.ts          # メイン診断API
│   │   ├── classify/
│   │   │   └── route.ts          # 画像分類API
│   │   └── share/
│   │       └── route.ts          # 共有機能API
│   ├── share/
│   │   └── [id]/
│   │       └── page.tsx          # 共有ページ
│   ├── page.tsx                  # メインページ
│   ├── layout.tsx                 # レイアウト
│   └── globals.css                # グローバルスタイル
├── lib/
│   ├── types.ts                   # 型定義
│   ├── extraction.ts              # 抽出モジュール
│   ├── verification.ts            # 検証モジュール
│   ├── diagnosis.ts               # 診断モジュール
│   ├── normalizer.ts              # 正規化モジュール
│   └── image-preprocessing.ts     # 画像前処理
├── public/                        # 静的ファイル
├── package.json
├── tsconfig.json
├── next.config.ts
└── tailwind.config.ts
```

## 🔑 主要機能

### 1. 通常診断モード

- **見積書の解析**: 初期費用の各項目を抽出
- **図面との照合**: 募集図面の記載と見積書を比較
- **矛盾検出**: 図面に「無料」とあるのに見積書で有料など
- **適正価格の算出**: 各項目の適正価格を計算
- **リスクスコア**: 払いすぎ危険度を0-100で表示

### 2. 裏コマンドモード（エンタメ機能）

見積書以外の画像をアップロードすると、特別な診断を表示：

- **顔写真**: マダム・エステートの運命鑑定
- **動物**: ドクター・アニマルエステートの特別鑑定
- **食べ物**: グルメ・エステート卿の三ツ星鑑定
- **その他**: マスター・エステートの万物鑑定

各診断では、ポジティブな内容で「褒め倒す」形式で運勢を表示。

### 3. 共有機能

- **SNSシェア**: X、LINEで診断結果をシェア
- **共有リンク**: 24時間有効な共有リンクを生成
- **画像保存**: 診断結果を画像として保存

### 4. カメラ機能

- **リアルタイム撮影**: スマートフォンのカメラで直接撮影
- **ガイド枠**: 撮影時のガイド表示
- **画像圧縮**: アップロード前に自動圧縮

## 🧠 設計思想

### 1. 抽出と診断の分離

- **抽出フェーズ**: 画像から「事実」のみを抽出（診断はしない）
- **診断フェーズ**: 抽出されたJSONデータのみで診断（画像は見ない）

### 2. 根拠（Evidence）の重視

- 各値には必ず`evidence_text`（根拠テキスト）を付与
- `evidence`がない項目は`value`を`null`に（0にしない）
- 0にするのは「礼0」「無料」など明確な記載がある場合のみ

### 3. 不確実性の明示

- 読み取りに不確実性がある項目は「要確認」として表示
- ユーザーに手動確認を促す

### 4. 矛盾検出と再検証

- 図面と見積書で矛盾がある項目は再検証
- 再検証でも確認できない場合は「要確認」として扱う

## 📊 データ構造

### ExtractedFacts（抽出結果）

```typescript
{
  property_name: ExtractedField<string>,
  room_number: ExtractedField<string>,
  rent: ExtractedField<number>,
  deposit_months: ExtractedField<number>,
  key_money_months: ExtractedField<number>,
  brokerage_fee: ExtractedField<number>,
  // ... その他の項目
  other_items: ExtractedOtherItem[],
  total_items_found: number
}
```

### ExtractedField（個別フィールド）

```typescript
{
  value: T | null,              // 抽出された値（evidenceがない場合はnull）
  evidence_text: string | null, // 画像から抽出した原文
  confidence: number,           // 信頼度 0-1
  source: "flyer" | "estimate", // 抽出元
  page_or_image_index: number
}
```

### DiagnosisResult（診断結果）

```typescript
{
  property_name: string,
  room_number: string,
  items: DiagnosisItem[],
  total_original: number,
  total_fair: number,
  discount_amount: number,
  risk_score: number,
  pro_review: { content: string },
  has_unconfirmed_items: boolean,
  unconfirmed_item_names: string[]
}
```

## 🎨 UI/UXの特徴

### デザイン

- **ダークテーマ**: スレート系のダークカラーをベース
- **グラデーション**: ブルー系のグラデーションで視覚的な魅力
- **アニメーション**: フェードイン、スケールインなどのアニメーション

### ユーザビリティ

- **レスポンシブ**: スマートフォンとデスクトップの両方に対応
- **直感的な操作**: ドラッグ&ドロップ、カメラ撮影など
- **進捗表示**: 診断中の進捗率とメッセージを表示

## 🔒 セキュリティ・プライバシー

- **個人情報の除外**: 共有リンクには物件名などの個人情報を含めない
- **一時保存**: 共有データは24時間後に自動削除
- **APIキー**: 環境変数で管理

## 🚀 今後の展開・改善予定

1. **診断精度の向上**
   - より多くの見積書パターンに対応
   - 地域別の相場データの追加

2. **機能拡張**
   - 過去の診断履歴の保存
   - 複数物件の比較機能
   - PDFファイルの直接アップロード対応

3. **パフォーマンス改善**
   - 画像前処理の最適化（sharpライブラリの導入）
   - キャッシュ機能の追加

4. **ビジネス機能**
   - ユーザー登録機能
   - 診断結果の詳細レポート生成
   - 不動産コンサルタントとのマッチング

5. **エンタメ機能の拡充**
   - より多くの裏コマンドタイプの追加
   - 診断結果のバリエーション増加

## 📝 開発メモ

- **環境変数**: `.env.local`に`GEMINI_API_KEY`を設定
- **デプロイ**: Vercelに自動デプロイ
- **API制限**: Gemini APIのレート制限に注意（429エラー対応済み）

## 🐛 既知の課題

1. **画像品質依存**: 画像の品質によって読み取り精度が変動
2. **表記ゆれ**: 不動産会社ごとの表記の違いに対応が必要
3. **複数ページ**: 見積書が複数ページの場合の対応が不完全

## 📚 参考資料

- [Next.js Documentation](https://nextjs.org/docs)
- [Google Gemini API](https://ai.google.dev/)
- [Tailwind CSS](https://tailwindcss.com/)

